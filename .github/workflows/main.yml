name: Deploy to Remote Server

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'è¯·é€‰æ‹©æ„å»ºåˆ†æ”¯'
        required: true
        type: choice
        options:
          - dev
          - master
        default: dev
      app_env:
        description: 'è¯·é€‰æ‹©è¦æ„å»ºåˆ°çš„é¡¹ç›®ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - test
          - prod
        default: test
      cache_strategy:
        description: 'æ„å»ºç¼“å­˜ç­–ç•¥'
        required: true
        type: choice
        options:
          - "âš¡ ä½¿ç”¨ç¼“å­˜æ„å»º (use_cache)"
          - "ğŸ› ï¸ æ¸…é™¤ä¸šåŠ¡ç¼“å­˜ (no_cache)"
          - "ğŸ§¨ å½»åº•å…¨é‡æ„å»º (full_reset)"
        default: "âš¡ ä½¿ç”¨ç¼“å­˜æ„å»º (use_cache)"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: executing remote ssh commands to develop
      uses: appleboy/ssh-action@master
      with:
        host: ${{ github.event.inputs.app_env == 'prod' && secrets.PROD_SSH_HOST || secrets.TEST_SSH_HOST }}
        username: ${{ github.event.inputs.app_env == 'prod' && secrets.PROD_SSH_USERNAME || secrets.TEST_SSH_USERNAME }}
        key: ${{ github.event.inputs.app_env == 'prod' && secrets.PROD_SSH_KEY || secrets.TEST_SSH_KEY }}
        command_timeout: "60m"
        script: |
          cd /
          chmod +x /usr/local/wujiaying/repos/egeek/build-git-pull.sh
          /usr/local/wujiaying/repos/egeek/build-git-pull.sh -branch_name ${{ github.event.inputs.branch_name }}
          
          chmod +x /usr/local/wujiaying/repos/egeek/build.sh
          
          # --- ç¼“å­˜å‚æ•°è§£æé€»è¾‘ ---
          RAW_STR="${{ github.event.inputs.cache_strategy }}"
          # ä½¿ç”¨ grep æå–æ‹¬å·å†…çš„å€¼ (use_cache / no_cache / full_reset)
          CACHE_VALUE=$(echo $RAW_STR | grep -oP '\(\K[^\)]+')
          
          CACHE_PARAMS=""
          case "$CACHE_VALUE" in
            "no_cache")
              CACHE_PARAMS="--no-cache"
              ;;
            "full_reset")
              CACHE_PARAMS="--no-cache --full-reset"
              ;;
            *)
              CACHE_PARAMS="" # é»˜è®¤ä¸º use_cache
              ;;
          esac

          APP_MAILER_PASSWORD="${{ secrets.MAILER_PASSWORD }}" \
          APP_BDY_ACCESS_KEY="${{ secrets.BDY_ACCESS_KEY }}" \
          APP_BDY_SECRET_KEY="${{ secrets.BDY_SECRET_KEY }}" \
          APP_JDY_ACCESS_KEY="${{ secrets.JDY_ACCESS_KEY }}" \
          APP_JDY_SECRET_KEY="${{ secrets.JDY_SECRET_KEY }}" \
          APP_OSS_ACCESS_KEY_ID="${{ secrets.OSS_ACCESS_KEY_ID }}" \
          APP_OSS_ACCESS_KEY_SECRET="${{ secrets.OSS_ACCESS_KEY_SECRET }}" \
          APP_DEEPSEEK_API_SECRET_KEY="${{ secrets.DEEPSEEK_API_SECRET_KEY }}" \
          APP_SILICONFLOW_API_SECRET_KEY="${{ secrets.SILICONFLOW_API_SECRET_KEY }}" \
          APP_PYTHON_API_SECRET_KEY="${{ secrets.PYTHON_API_SECRET_KEY }}" \
          APP_MYSQL_ROOT_PASSWORD="${{ github.event.inputs.app_env == 'prod' && secrets.PROD_MYSQL_ROOT_PASSWORD || secrets.TEST_MYSQL_ROOT_PASSWORD }}" \
          APP_MYSQL_PASSWORD="${{ github.event.inputs.app_env == 'prod' && secrets.PROD_MYSQL_PASSWORD || secrets.TEST_MYSQL_PASSWORD }}" \
          APP_MYSQL_PASSWORD_${{ github.event.inputs.app_env }}="${{ github.event.inputs.app_env == 'prod' && secrets.PROD_MYSQL_PASSWORD || secrets.TEST_MYSQL_PASSWORD }}" \
          APP_REDIS_ROOT_PASSWORD="${{ github.event.inputs.app_env == 'prod' && secrets.PROD_REDIS_ROOT_PASSWORD || secrets.TEST_REDIS_ROOT_PASSWORD }}" \
          APP_REDIS_PASSWORD="${{ github.event.inputs.app_env == 'prod' && secrets.PROD_REDIS_PASSWORD || secrets.TEST_REDIS_PASSWORD }}" \
          APP_REDIS_PASSWORD_${{ github.event.inputs.app_env }}="${{ github.event.inputs.app_env == 'prod' && secrets.PROD_REDIS_PASSWORD || secrets.TEST_REDIS_PASSWORD }}" \
          /usr/local/wujiaying/repos/egeek/build.sh \
          -env ${{ github.event.inputs.app_env }} \
          ${CACHE_PARAMS}
